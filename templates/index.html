<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
    <title>Geo AR</title>
	 <style>
		#overlay {
		  position: absolute;
		  top: 50px;
		  left: 34%;
		  overflow: scroll;
		  color: #FFF;
		  text-align: center;
		  font-size: 20px;
		  background-color: rgba(221, 221, 221, 0.4);
		  width: 33%;
		  height: 380px;
		  padding: 10px 0;
		  z-index: 2147483647;
		  visibility: hidden;
		}

		#video {
		  z-index: 1;
		  width: 33%
		}
	 </style>
	 <link rel="shortcut icon"
    href="{{ url_for('static', filename='img/favicon.ico') }}">
</head>
<body>
<div style="text-align: center">
<button id="left" width="40" height="480">&lt;</button>
<video id="video" height="480" autoplay></video>
<div id="overlay">This is HTML overlay on top of the video! </div>
<button id="right" width="40">&gt;</button>
<br/>
<button id="snap">Get Info</button>
</div>
<script type="text/javascript">
var latitude = 0;
var longitude = 0;
var data_string = "";
var reviews = {"reviews":[]}
var review_index = 0;

value = 0;
function deviceOrientationListener(event){
    console.log("The alpha is " + event.alpha.geolocation);
    console.log("The beta is " + event.beta);
    console.log("The gamma is " + event.gamma);
    value = event;
    document.getElementById("phoneOrientation").innerHTML = "alpha: " + value.alpha + " beta: " + event.beta + " gamma: " + event.gamma;

}

(function getLocation() {
    var location = null;
	
    if(window.navigator && window.navigator.geolocation){
        geolocation = window.navigator.geolocation;
    }
    if(geolocation){
        geolocation.getCurrentPosition(function(position){
			latitude = position.coords.latitude;
			longitude = position.coords.longitude;
			data_string = "latitude="+latitude+"&longitude="+longitude+"&radius=100";
            console.log(position);
        });
        var identifier = geolocation.watchPosition(function(position){
            console.log(position);
        });
        console.log(identifier);
    }
    else{
        document.getElementById("location").innerHTML = "Can't find location";
    }
	
	// Grab elements, create settings, etc.
	var video = document.getElementById('video');

	// Get access to the camera!
	if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		// Not adding `{ audio: true }` since we only want video now
		navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
			video.src = window.URL.createObjectURL(stream);
			video.play();
		});
	}
	// Elements for taking the snapshot
	var video = document.getElementById('video');

	// Trigger photo take
	document.getElementById("snap").addEventListener("click", function() {
		getInfo();
	});
	document.getElementById("left").addEventListener("click", function() {
		if(review_index > 0)
		{
			review_index--;
			buildOverlay();
		}
	});
	document.getElementById("right").addEventListener("click", function() {
		if(review_index < reviews.reviews.length - 1)
		{
			review_index++;
			buildOverlay();
		}
	});
})()

	
function getInfo(){
	$.ajax({
		url: "https://719a21bd.ngrok.io/get_closest",
		type: "POST",
		data: String(data_string),
		contentType: 'application/x-www-form-urlencoded',
		success: function (result){
			for(var key in result){
				console.log(result[key]);
			}
			reviews = result;
			buildOverlay();
		}
	});
}

function buildOverlay()
{
	var review_list = reviews.reviews;
	var review_text = "";

	var averageReview = 0.0;
	var totalSum = 0.0;
	if(review_list !== undefined)
	{
		for(var i = 0; i < review_list.length; i++)
		{
			console.log(review_list[i].rating);
			totalSum += review_list[i].rating;
			//review_text += (i+1) + ") " + review_list[i].text + "<br/>";
		}
		averageReview = totalSum/review_list.length;
		document.getElementById("overlay").innerHTML = reviews.place_info.name + "<br/>";
		for(var i = 1; i < averageReview; i++)
		{
			document.getElementById("overlay").innerHTML += "<img width=30 height=30 src={{ url_for('static', filename='filled_star.png') }}></img>";
		}
		for(i; i < 6; i++)
		{
			document.getElementById("overlay").innerHTML += "<img width=30 height=30 src={{ url_for('static', filename='empty_star.png') }}></img>";
		}
		document.getElementById("overlay").innerHTML += "<br/>Reviews:<br/>" + review_list[review_index].text;
		document.getElementById("overlay").style.visibility = "visible";
	}
}

</script>
</body>


</html>